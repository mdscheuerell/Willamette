---
title: \Large{Development and application of an integrated population model for Chinook salmon in the Willamette River basin}
output:
  pdf_document:
    includes:
      before_body: before_body.tex
    highlight: haddock
    toc: true
    number_sections: true
    toc_depth: '3'
fontsize: 11pt
geometry: margin=1in
bibliography: willamette.bib
csl: jpe.csl
header-includes:
  \makeatletter\renewcommand*{\fps@figure}{H}\makeatother
---

```{r set_options, echo = FALSE, message = FALSE}
options(width = 100)
knitr::opts_chunk$set(message = FALSE)
## for figure captions
library("captioner")
## set default caption options
fig_cap <- captioner(suffix = ".", style = "b", style_prefix = TRUE)
tbl_cap <- captioner(prefix = "Table", suffix = ".",
                     style = "b", style_prefix = TRUE)
## for tables
library(kableExtra)
## jags dir
jagsdir <- here::here("jags")
```

\vspace{0.2in}

This is version `r paste0('0.',format(Sys.time(), '%y.%m.%d'))`.

\newpage

# Summary {-}


# Introduction


# Methods

## Process models

### Total recruits

We begin with our process model that describes the true, but unknown production of offspring from their parents. In any given year _t_, spawning adults produce some number of surviving offspring, which follows a general Ricker model (Figure 1), such that
	
\begin{equation}
R_t = \frac{\alpha S_t}{\mathrm{e}^{\beta S_t}}.
\end{equation}

Here $R_t$ is the total number of subsequent recruits (offspring) born in year _t_; $S_t$ is the true, but unobserved, number of spawning adults; $\alpha$ is the intrinsic productivity; and $\beta$ is the strength of density dependence.

In this case, however, I make two modifications to Eqn (1): _i_) allow the intrinsic productivity to vary over time, and _ii_) allow for additional unexplained annual variation. Specifically, the model becomes (in log-space)

\begin{equation}
\log(R_t) = \log(S_t) + a_t - b S_t + w_t.
\end{equation}

Here $a_t$ is the log of the annual density-independent productivity ($a = \log \alpha$), $b = \beta$ and $w_t$ is autocorrelated over time according to $w_t \sim \text{N}(\phi w_{t-1}, q_a)$. Previous applications of time-varying productivity [e.g., @peterman2003; @dorner2008] have used a Markov form where $a_t \sim \text{N}(a_{t-1}, \sigma_a)$, but here we will model $a_t$ as a function of time-varying covariates. Specifically,

\begin{equation}
a_t = \bar{a} + \sum_{i=1}^{M} c_{i,t} \ X_{i,t+h},
\end{equation}

$\bar{a}$ is the underlying mean productivity, and $c_{i,t}$ is the effect of covariate $i$ at time $t$, $X_{i,t+h}$. To allow for direct comparison of effect sizes, the covariates are typically standardized to have a zero mean and unit variance.

### Age-specific survival & maturation

The estimated number of fish of age $a$ returning in year $t$ $(N_{a,t})$ is then product of the total number of brood-year recruits in year $t - a$ and the proportion of mature fish from that brood year that returned to spawn at age $a$ $(p_{a,t-a})$, such that

\begin{equation}
N_{a,t} = R_{t-a} \ p_{a,t-a}.
\end{equation}

The vector of age-specific return rates for brood year $t$ $(\mathbf{p}_t)$ has length $A$, which equals the number of adult age classes. That is, $\mathbf{p}_t$ is a combination of the probability of surviving to, and maturing in years $t + a_{\min}$ to $t + a_{\max}$ (_i.e._, $t + 3$ to $t + 6$). We modeled $(\mathbf{p}_t)$ as a random effect using a hierarchical form of the Dirichlet distribution, where

\begin{equation}
\mathbf{p}_t \sim \text{Dirichlet}(\boldsymbol{\mu},\pi).
\end{equation}

In this formulation, the mean vector $\boldsymbol{\mu}$ is itself distributed as a Dirichlet, and therefore has a total of $A$ elements that are all greater than zero. The precision parameter $\pi$ affects each of the elements in $\boldsymbol{\mu}$, such that large values of $\pi$ results in values of $\mathbf{p}_t$ that are very close to $\boldsymbol{\mu}$.

\vspace{0.25in}

\begin{center}
\includegraphics[width=0.6\textwidth]{figures/Fig_1_Ricker_form}
\end{center}

```{r, echo=FALSE}
cnt <- 1
```

\small

`r fig_cap(cnt, caption = "Deterministic form of the Ricker model used in the analysis. The parameter $\\alpha$ is the slope at the origin and the derived parameter $K$ is the carrying capacity. The gray line is where $R_t = S_t$.", display = "full")` 

\normalsize

## Observation models

### Spawners

Estimates of the number of spawning adults necessarily contain some sampling or observation errors due to incomplete censuses, mis-identification, etc. Therefore, I assume that the estimates of escapement $(E_t)$ are log-normally distributed about the true number of spawners $(S_t)$, such that

\begin{equation}
\log(E_t) \sim \text{Normal}(\log(S_t), r_s).
\end{equation}

There is no harvest of natural-origin fish within the freshwater portion of the basin, so the total number of spawners equals the sum of the age-specific totals, such that

\begin{equation}
S_t = \sum_{a=3}^6 N_{a,t}.
\end{equation}

### Age composition

The age composition data include the number of fish in each age class $a$ in year $t$ $(O_{a,t})$. The vector of age data $\mathbf{O}_t = [O_{3,t} ~ O_{4,t} ~ O_{5,t} ~ O_{6,t}]$ is then modeled as a multinomial process with order $Y_t$ and proportion vector $\mathbf{d}_t = [d_{3,t} ~ d_{4,t} ~ d_{5,t} ~ d_{6,t}]$, such that

\begin{equation}
\mathbf{O}_t \sim \text{Multinomial}(Y_t, \mathbf{d}_t).
\end{equation}

The order of the multinomial is simply the sum of the observed numbers of fish across all ages returning in year $t$

\begin{equation}
Y_t = \sum_{a=3}^6 O_{a,t}.
\end{equation}

The proportion vector $\mathbf{d}_t$ for the multinomial is based on the age-specific, model-derived estimates of adult returns in year $t$ $(N_{a,t})$ and the true number of total spawners $(S_t)$, such that

\begin{equation}
d_{a,t} = \frac{N_{a,t}}{S_t}.
\end{equation}


## Model fitting

I used Bayesian inference to estimate all model parameters and the unobserved true numbers of spawners and recruits over time. I used version 3.5 of the __R__ [@R2018] for data retrieval, data processing, and summarizing model results, and version 4.2 of the __JAGS__ software [@jags] for Markov chain Monte Carlo (MCMC) simulation. Specifically, I used 4 chains with $1.3 \times 10^5$ iterations each. Following a burn-in period of $5 \times 10^4$, I retained every 100^th^ sample for a total of 5000 samples from the posterior distributions.

I assessed convergence and diagnostic statistics via the __CODA__ package in __R__ [@plummer2006]. Specifically, I used visual inspection of trace plots and density plots, and verified that Gelman and Rubinâ€™s [-@GR1992] potential scale reduction factor was less than 1.1, to ensure adequate chain mixing and parameter convergence. I evaluated the out-of-sample predictive ability of each model using the leave-one-out information criterion (LOOIC) as estimated via the __loo__ package for __R__ [@vehtari2017].


# Results

## Model selection

\small

`r tbl_cap(1, caption = "Table of model selection results with models ranked from greatest to least data support. Columns correspond to the life stage at which the flow effect would be expected to manifest itself (Life stage); the statistic used to summarize flow (Stat); the beginning and ending dates over which the flow was summarized expressed as month-day (Begin, End); the number of years by which the flow covariate was lagged relative to the brood year (Lag); the number of effective parameters $(p_e)$; the leave-one-out information criterion (LOOIC) and its standard error (se LOOIC); and the difference in LOOIC among models ($\\Delta$LOOIC). The model where \"Life stage = base\" does not contain any effect of flow.", display = "full")` 

\normalsize

```{r, echo = FALSE}
## load LOOIC info
tbl_LOOIC <- readRDS(file.path(jagsdir, "tbl_LOOIC.rds"))
tbl_LOOIC <- tbl_LOOIC[,!(names(tbl_LOOIC) %in% "se_p_loo")]
## print table
knitr::kable(tbl_LOOIC[order(tbl_LOOIC[,"looic"]),],
             format = "latex",
             booktabs = TRUE,
             col.names = c("Life stage",
                           "Stat",
                           "Begin",
                           "End",
                           "Lag",
                           "$p_e$",
                           "LOOIC",
                           "se LOOIC",
                           "$\\Delta$LOOIC"),
             escape = FALSE,
             row.names = FALSE,
             align = c("l", rep("c", 8))) %>%
  kable_styling(position = "center", font_size = 10)
```




# Discussion


# Acknowledgments {-}


# References {-}  

\setlength{\parindent}{-0.375in}
\setlength{\leftskip}{0.375in}
\setlength{\parskip}{8pt}
\noindent

 



